#!/bin/bash

#PBS -l nodes=1:ppn=1
#PBS -l walltime=1:30:00
#PBS -N app-cortex-mapping-stats
#PBS -V

set -e

[ ! -d ./parc-stats ] && mkdir -p ./parc-stats

# copy license and export path for freesurfer
[ -z "$FREESURFER_LICENSE" ] && echo "Please set FREESURFER_LICENSE in .bashrc" && exit 1;
echo $FREESURFER_LICENSE > license.txt

# compute statistics
time singularity exec -e -B `pwd`/license.txt:/usr/local/freesurfer/license.txt docker://brainlife/freesurfer:7.2.0 ./compute-stats.sh

# attepmt to grab provenance information from config to set important informtation in meta data of output (i.e. the particular atlas of the parcellation)
if [ -f ./lh.parc.annot ]; then
	parc_id=`jq -r '._inputs[] | select(.id == "parc_surface") | .dataset_id' config.json`
	curl https://brainlife.io/api/warehouse/dataset/prov/$parc_id > prov.json
fi

# generate csv's for each statistic that can be useful in MLC analyses
time singularity exec -e docker://brainlife/freesurfer-stats:1.2 ./generateCSV.py

if [ -f ./parc-stats/parc-stats/merged.csv ]; then
	mkdir raw
	mv *.gii *.txt *.csv *.annot ./raw/
	mv ./raw/license.txt ../
	cp ./parc-stats/parc-stats/merged.csv ./parc-stats/parc-stats/cortex.csv
	echo "complete"
	exit 0
else
	echo "stats computations failed somewhere. please check logs and derivatives"
	exit 1
fi
