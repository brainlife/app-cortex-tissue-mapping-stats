#!/bin/bash
#PBS -l nodes:1,ppn:1,walltime=10:00:00,vmem=30gb
#PBS -N app-parc-stats
#PBS -V

[ -z "$FREESURFER_LICENSE" ] && echo "Please set FREESURFER_LICENSE in .bashrc" && exit 1;
echo $FREESURFER_LICENSE > license.txt

# bin by prf measure and make varea label
time singularity exec -e -B `pwd`/license.txt:/usr/local/freesurfer/license.txt docker://brainlife/freesurfer:7.3.2 ./funkmaker.sh

# create labels
time singularity exec -e docker://brainlife/connectome_workbench:1.5.0-freesurfer-update ./labelmaker.sh

# create lut file
time singularity exec -e docker://brainlife/freesurfer-stats:1.2 ./createColorLUT.py

# compute stats
time singularity exec -e -B `pwd`/license.txt:/usr/local/freesurfer/license.txt docker://brainlife/freesurfer:7.3.2 ./computestats.sh

# build output csv
time singularity exec -e docker://brainlife/freesurfer-stats:1.2 ./build_parc_stats.py

# check if output file is missing. if so, exit
if [ ! -f ./parc-stats/parc-stats/endpoints.csv ]; then
    echo "something went wrong. check logs and derivatives"
    exit 1
fi

# if pass, finish up
echo "complete"
mkdir raw
mv *.gii *.curv.txt *varea*.txt lut.txt raw/
exit 0
